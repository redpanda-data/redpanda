- Feature Name: Exactly Once Delivery and Transactional Messaging in Redpanda
- Status: draft
- Start Date: 2020-11-17
- Authors: Denis Rystsov
- Issue: 

The goal for the project is to support Kafka's [transactional API](https://docs.google.com/document/d/11Jqy_GjUGtdXJK94XGsEIK7CP1SnQGdp2eF0wSw9ra8/edit) for full description). Our tests demonstrated that on some workloads transactional processing in Kafka has more than 300% overhead in latency compared to an equivalent workload without transactions. So we decided to design Redpanda's transactions from scratch to avoid that penalty.

## Example

### Commit, happy case

```
+---------+                               +-------------+                               +-------------+                          +-------------+                          +---------------+
| client  |                               | coordinator |                               | partition_1 |                          | partition_2 |                          | id_allocator  |
+---------+                               +-------------+                               +-------------+                          +-------------+                          +---------------+
     |                                           |                                             |                                        |                                         |
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     |                                           |                                             |                                        |                                         |  Client initializes a producer
     | find_coordinator                          |                                             |                                        |                                         |
     | { tx.id }                                 |                                             |                                        |                                         |  .initTransactions()
     |---------------------------------------------------------------------------------------->|                                        |                                         |
     |                                           |                                             |                                        |                                         |
     |                                           |                             { coordinator } |                                        |                                         |
     |<----------------------------------------------------------------------------------------|                                        |                                         |
     |                                           |                                             |                                        |                                         |
     | init_producer_tx                          |                                             |                                        |                                         |
     | { tx.id }                                 |                                             |                                        |                                         |
     |------------------------------------------>|                                             |                                        |                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | allocate                                    |                                        |                                         |
     |                                           |------------------------------------------------------------------------------------------------------------------------------->|
     |                                           |                                             |                                        |                                 { pid } |
     |                                           |<-------------------------------------------------------------------------------------------------------------------------------|
     |                                           |                                             |                                        |                                         |
     |                                           | -------------------------------------\      |                                        |                                         |
     |                                           |-| assume hasn't seen tx.id           |      |                                        |                                         |
     |                                           | | // set in mem:                     |      |                                        |                                         |
     |                                           | | tx[tx.id] = TX(                    |      |                                        |                                         |
     |                                           | |   pid=pid,                         |      |                                        |                                         |
     |                                           | |   epoch=0,                         |      |                                        |                                         |
     |                                           | |   tx_seq=0,                        |      |                                        |                                         |
     |                                           | |   status="ongoing",                |      |                                        |                                         |
     |                                           | |   p={}                             |      |                                        |                                         |
     |                                           |-| )                                  |      |                                        |                                         |
     |                                           | |------------------------------------|      |                                        |                                         |
     |                            { pid, epoch } |                                             |                                        |                                         |
     |<------------------------------------------|                                             |                                        |                                         |
     |                                           |                                             |                                        |                                         |
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     |                                           |                                             |                                        |                                         |  Client starts a transaction
     | add_partitions_to_txn                     |                                             |                                        |                                         |  and sends a first batch, behind
     | { tx.id, pid, epoch, partition_1 }        |                                             |                                        |                                         |  the scene it triggers 
     |------------------------------------------>|                                             |                                        |                                         |  add_partitions_to_txn API
     |                                           | -------------------------------------\      |                                        |                                         |
     |                                           |-| assert tx[tx.id].status=="ongoing" |      |                                        |                                         |  .beginTransaction()
     |                                           | |------------------------------------|      |                                        |                                         |  .send(...)
     |                                           |                                             |                                        |                                         |
     |                                           | begin_tx { pid, epoch }                     |                                        |                                         |
     |                                           |-------------------------------------------->|                                        |                                         |
     |                                           |                                             | --------------------------------\      |                                         |
     |                                           |                                             |-| if hasn't seen {pid, epoch}:  |      |                                         |
     |                                           |                                             | |   wait write(                 |      |                                         |
     |                                           |                                             | |     "fence", pid, epoch       |      |                                         |
     |                                           |                                             |-|   ) ack=all                   |      |                                         |
     |                                           |                                             | |-------------------------------|      |                                         |
     |                                           |                                    { term } |                                        |                                         |
     |                                           |<--------------------------------------------|                                        |                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | ----------------------------------\         |                                        |                                         |
     |                                           |-| // update in mem                |         |                                        |                                         |
     |                                           |-| tx[tx.id].p[partition_1]=term   |         |                                        |                                         |
     |                                           | |---------------------------------|         |                                        |                                         |
     |                                        ok |                                             |                                        |                                         |
     |<------------------------------------------|                                             |                                        |                                         |
     |                                           |                                             |                                        |                                         |
     | produce {pid, epoch, [events]}            |                                             |                                        |                                         |
     |---------------------------------------------------------------------------------------->|                                        |                                         |
     |                                           |                                             | ------------------------------\        |                                         |
     |                                           |                                             |-| wait write([events]) acks=1 |        |                                         |
     |                                           |                                             | |-----------------------------|        |                                         |
     |                                           |                                             |                                        |                                         |
     |                                           |                                    {offset} |                                        |                                         |
     |<----------------------------------------------------------------------------------------|                                        |                                         |
     |                                           |                                             |                                        |                                         |
     | add_partitions_to_txn                     |                                             |                                        |                                         |
     | { tx.id, pid, epoch, partition_2 }        |                                             |                                        |                                         |
     |------------------------------------------>|                                             |                                        |                                         |
     |                                           | -------------------------------------\      |                                        |                                         |
     |                                           |-| assert tx[tx.id].status=="ongoing" |      |                                        |                                         |
     |                                           | |------------------------------------|      |                                        |                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | begin_tx({ pid, epoch, tx_seq })            |                                        |                                         |
     |                                           |------------------------------------------------------------------------------------->|                                         |
     |                                           |                                             |                                        | --------------------------------\       |
     |                                           |                                             |                                        |-| if hasn't seen {pid, epoch}:  |       |
     |                                           |                                             |                                        | |   wait write(                 |       |
     |                                           |                                             |                                        | |     "fence", pid, epoch       |       |
     |                                           |                                             |                                        |-|   ) ack=all                   |       |
     |                                           |                                             |                                        | |-------------------------------|       |
     |                                           |                                             |                               { term } |                                         |
     |                                           |<-------------------------------------------------------------------------------------|                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | ----------------------------------\         |                                        |                                         |
     |                                           |-| // update in mem                |         |                                        |                                         |
     |                                           |-| tx[tx.id].p[partition_2]=term   |         |                                        |                                         |
     |                                           | |---------------------------------|         |                                        |                                         |
     |                                        ok |                                             |                                        |                                         |
     |<------------------------------------------|                                             |                                        |                                         |
     |                                           |                                             |                                        |                                         |
     | produce {pid, epoch, [events]}            |                                             |                                        |                                         |
     |--------------------------------------------------------------------------------------------------------------------------------->|                                         |
     |                                           |                                             |                                        | ------------------------------\         |
     |                                           |                                             |                                        |-| wait write([events]) acks=1 |         |
     |                                           |                                             |                                        | |-----------------------------|         |
     |                                           |                                             |                               {offset} |                                         |
     |<---------------------------------------------------------------------------------------------------------------------------------|                                         |
     |                                           |                                             |                                        |                                         |
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     |                                           |                                             |                                        |                                         |  Client commits a transactions
     | end_tx {tx.id, pid, epoch, true}          |                                             |                                        |                                         |
     |------------------------------------------>|                                             |                                        |                                         |  .commitTransaction()
     |                                           | -------------------------------\            |                                        |                                         |
     |                                           |-| // update in mem             |            |                                        |                                         |  There is only one write/fsync
     |                                           | | tx[tx.id].status="preparing" |            |                                        |                                         |  delay - all the writes
     |                                           | | F = write(tx[tx.id]) ack=all |            |                                        |                                         |  on the coordinator and on the 
     |                                           | |------------------------------|            |                                        |                                         |  partitions happen in parallel
     |                                           |                                             |                                        |                                         |
     |                                           | prepare {pid, epoch, term, tx_seq}          |                                        |                                         |
     |                                           |-------------------------------------------->|                                        |                                         |
     |                                           | prepare {pid, epoch, term, tx_seq}          |                                        |                                         |
     |                                           |------------------------------------------------------------------------------------->|                                         |
     |                                           |                                             |                                        |                                         |
     |                                           |                                             | -----------------------------------\   |                                         |
     |                                           |                                             |-| wait write(                      |   |                                         |
     |                                           |                                             | |   "prepared", pid, epoch, tx_seq |   |                                         |
     |                                           |                                             |-| ) ack=all                        |   | -----------------------------------\    |
     |                                           |                                             | |----------------------------------|   |-| wait write(                      |    |
     |                                           |                                             |                                        | |   "prepared", pid, epoch, tx_seq |    |
     |                                           |                                             |                                        |-| ) ack=all                        |    |
     |                                           |                                          ok |                                        | |----------------------------------|    |
     |                                           |<--------------------------------------------|                                     ok |                                         |
     |                                           |<-------------------------------------------------------------------------------------|                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | ---------\                                  |                                        |                                         |
     |                                           |-| wait F |                                  |                                        |                                         |
     |                                           | |--------|                                  |                                        |                                         |
     |                                           |                                             |                                        |                                         |
     |                             {"committed"} |                                             |                                        |                                         |
     |<------------------------------------------|                                             |                                        |                                         |
     |                                           |                                             |                                        |                                         |  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     |                                           |                                             |                                        |                                         |  Clean happens after coordinator
     |                                           | ------------------------------\             |                                        |                                         |  acks the commit
     |                                           |-| // update in mem            |             |                                        |                                         |
     |                                           | | tx[tx.id].status="prepared" |             |                                        |                                         |
     |                                           |-| wait write(tx) ack=all      |             |                                        |                                         |
     |                                           | |-----------------------------|             |                                        |                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | commit {pid, epoch, tx_seq}                 |                                        |                                         |
     |                                           |-------------------------------------------->|                                        |                                         |
     |                                           | commit {pid, epoch, tx_seq}                 |                                        |                                         |
     |                                           |------------------------------------------------------------------------------------->|                                         |
     |                                           |                                             | ---------------------------\           |                                         |
     |                                           |                                             |-| if prepared(...):        |           |                                         |
     |                                           |                                             | |   wait write(            |           |                                         |
     |                                           |                                             | |     "commit", pid, epoch |           | ----------------------------\           |
     |                                           |                                             |-|   ) ack=all              |           |-| if prepared(...):         |           |
     |                                           |                                             | |--------------------------|           | |   wait write(             |           |
     |                                           |                                             |                                        | |     "commit", pid, epoch  |           |
     |                                           |                                          ok |                                        |-|   ) ack=all               |           |
     |                                           |<--------------------------------------------|                                     ok | |---------------------------|           |
     |                                           |<-------------------------------------------------------------------------------------|                                         |
     |                                           |                                             |                                        |                                         |
     |                                           | -------------------------------------\      |                                        |                                         |
     |                                           |-| // set in mem                      |      |                                        |                                         |
     |                                           | | tx[tx.id] = TX(                    |      |                                        |                                         |
     |                                           | |   pid=pid,                         |      |                                        |                                         |
     |                                           | |   epoch=0,                         |      |                                        |                                         |
     |                                           | |   tx_seq=tx_seq+1,                 |      |                                        |                                         |
     |                                           | |   status="ongoing",                |      |                                        |                                         |
     |                                           | |   p={}                             |      |                                        |                                         |
     |                                           |-| )                                  |      |                                        |                                         |
     |                                           | |------------------------------------|      |                                        |                                         |
     |                                           |                                             |                                        |                                         |  
```
