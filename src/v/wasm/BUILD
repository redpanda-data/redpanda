load("//bazel:build.bzl", "redpanda_cc_library")

redpanda_cc_library(
    name = "allocator",
    srcs = [
        "allocator.cc",
    ],
    hdrs = [
        "allocator.h",
    ],
    include_prefix = "wasm",
    visibility = ["//src/v/wasm:__subpackages__"],
    deps = [
        "//src/v/base",
        "@abseil-cpp//absl/container:btree",
        "@seastar",
    ],
)

redpanda_cc_library(
    name = "wasm",
    srcs = [
        "api.cc",
        "cache.cc",
        "engine_probe.cc",
        "engine_probe.h",
        "ffi.cc",
        "ffi.h",
        "logger.cc",
        "logger.h",
        "schema_registry.cc",
        "schema_registry.h",
        "schema_registry_module.cc",
        "schema_registry_module.h",
        "transform_module.cc",
        "transform_module.h",
        "transform_probe.cc",
        "wasi.cc",
        "wasi.h",
        "wasmtime.cc",
        "wasmtime.h",
    ],
    hdrs = [
        "include/wasm/api.h",
        "include/wasm/cache.h",
        "include/wasm/errc.h",
        "include/wasm/fwd.h",
        "include/wasm/transform_probe.h",
    ],
    strip_include_prefix = "include",
    visibility = ["//visibility:public"],
    deps = [
        ":allocator",
        "//src/v/base",
        "//src/v/bytes",
        "//src/v/bytes:iobuf",
        "//src/v/bytes:iobuf_parser",
        "//src/v/config",
        "//src/v/metrics",
        "//src/v/model",
        "//src/v/pandaproxy",
        "//src/v/reflection:type_traits",
        "//src/v/ssx:thread_worker",
        "//src/v/storage:parser_utils",
        "//src/v/strings:utf8",
        "//src/v/thirdparty/wasmtime",
        "//src/v/utils:human",
        "//src/v/utils:log_hist",
        "//src/v/utils:mutex",
        "//src/v/utils:named_type",
        "//src/v/utils:to_string",
        "//src/v/utils:vint",
        "//src/v/wasm/parser",
        "@abseil-cpp//absl/algorithm:container",
        "@abseil-cpp//absl/container:btree",
        "@abseil-cpp//absl/container:flat_hash_map",
        "@abseil-cpp//absl/strings",
        "@boost//:fusion",
        "@fmt",
        "@seastar",
    ],
)
