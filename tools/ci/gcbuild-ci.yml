steps:
- id: 'create .git/ folder'
  name: 'alpine/git:v2.24.1'
  entrypoint: '/bin/sh'
  args:
  - '-c'
  - |
    if [[ ! -d ".git/" ]]; then
      if [[ "$_GITHUB_API_TOKEN" == "na" ]]; then
        echo "Expecting value for _GITHUB_API_TOKEN"
        exit 1
      fi
      git init
      git remote add origin https://$_GITHUB_API_TOKEN@github.com/vectorizedio/v
      git fetch --depth=200 origin $COMMIT_SHA
      git reset --hard FETCH_HEAD
    fi

- id: 'build builder image'
  name: 'gcr.io/kaniko-project/executor:debug-v0.19.0'
  entrypoint: '/busybox/sh'
  args:
  - '-c'
  - >-
    /kaniko/executor \
      --dockerfile=tools/ci/Dockerfile \
      --build-arg="COMPILER=$_COMPILER" \
      --build-arg="BUILD_TYPE=$_BUILD_TYPE" \
      --build-arg="GITHUB_API_TOKEN=$_GITHUB_API_TOKEN" \
      --destination="gcr.io/$PROJECT_ID/builder:$_COMPILER-$_BUILD_TYPE-$SHORT_SHA" \
      --cache=true \
      --cache-ttl=96h

- id: 'install vtools and test it'
  name: 'gcr.io/$PROJECT_ID/builder:$_COMPILER-$_BUILD_TYPE-$SHORT_SHA'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    python3 -mvenv build/venv/v && \
    source build/venv/v/bin/activate && \
    pip install tools/ && \
    vtools test py && \
    vtools install infra-deps

- id: 'check source code formatting'
  name: 'gcr.io/$PROJECT_ID/builder:$_COMPILER-$_BUILD_TYPE-$SHORT_SHA'
  entrypoint: 'bash'
  args:
  - -c
  - |
    if [[ "$_COMPILER" == "clang" ]]; then
      ./build/venv/v/bin/vtools fmt all --check --conf=tools/ci/vtools-clang-release.yml
    fi

- id: 'test rpk'
  name: 'gcr.io/$PROJECT_ID/builder:clang-release-$SHORT_SHA'
  args: ['./build/venv/v/bin/vtools', 'test', 'go', '--conf=tools/ci/vtools-clang-release.yml']

- id: 'build redpanda'
  name: 'gcr.io/$PROJECT_ID/builder:$_COMPILER-$_BUILD_TYPE-$SHORT_SHA'
  args: ['./build/venv/v/bin/vtools', 'build', 'cpp', '--conf=tools/ci/vtools-$_COMPILER-$_BUILD_TYPE.yml', '--skip-external']

- id: 'test redpanda'
  name: 'gcr.io/$PROJECT_ID/builder:$_COMPILER-$_BUILD_TYPE-$SHORT_SHA'
  args: ['./build/venv/v/bin/vtools', 'test', 'cpp', '--conf=tools/ci/vtools-$_COMPILER-$_BUILD_TYPE.yml']

timeout: 3600s

options:
  machineType: 'N1_HIGHCPU_32'
